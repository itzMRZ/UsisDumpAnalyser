<!DOCTYPE html>
<html lang="en">
<head >
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Information Portal</title>

    <style>
        .section-match {
        color: #155724;
        background-color: #d4edda;
        padding: 2px 4px;
        border-radius: 4px;
        margin-right: 4px;
        font-weight: bold;
    }
    .time-match {
        color: #004085;
        background-color: #cce5ff;
        padding: 2px 4px;
        border-radius: 4px;
    }
        .data-status {
        padding: 10px;
        text-align: center;
        font-weight: bold;
        margin-bottom: 10px;
}
        /* All previous styles remain unchanged */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f2f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .button-container { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .semester-button { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; transition: background-color 0.3s; }
        .semester-button.active { background-color: #0056b3; }
        .semester-button:hover { background-color: #0056b3; }
        .search-container { margin-bottom: 20px; }
        #searchInput { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.12); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; font-weight: bold; }
        tr:hover { background-color: #f5f5f5; }
        .tba-info { color: #721c24; background-color: #f8d7da; padding: 8px; border-radius: 4px; }
        .match-group { margin: 10px 0; }
        .exact-match { color: #155724; background-color: #d4edda; padding: 4px; border-radius: 4px; }
        .section-history { color: #856404; background-color: #fff3cd; padding: 4px; border-radius: 4px; }
        .time-match { color: #004085; background-color: #cce5ff; padding: 4px; border-radius: 4px; }
        .semester-tag { font-size: 0.8em; color: #666; margin-left: 8px; }
        .pagination { margin: 20px 0; display: flex; gap: 10px; justify-content: center; }
        .seats-available { color: #155724; background-color: #d4edda; padding: 4px 8px; border-radius: 4px; }
        .seats-full { color: #721c24; background-color: #f8d7da; padding: 4px 8px; border-radius: 4px; }
        .error-message { color: #721c24; background-color: #f8d7da; padding: 12px; border-radius: 4px; margin: 10px 0; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div id="data-status" class="data-status"></div>
        <h1>Course Information Portal</h1>
        <div class="button-container">
            <button class="semester-button active" data-semester="fall" data-file="old-usisdump.json">Fall 2024</button>
            <button class="semester-button" data-semester="summer" data-file="summer-usisdump.json">Summer 2024</button>
            <button class="semester-button" data-semester="spring">Spring 2025</button>
        </div>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search by Course Code, Faculty, or Name...">
        </div>
        <div class="pagination">
            <button id="prevPage">Previous</button>
            <span id="pageInfo">Page 1 of 1</span>
            <button id="nextPage">Next</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Course Code</th>
                    <th>Section</th>
                    <th>Faculty Initial</th>
                    <th>Full Name</th>
                    <th>Class Schedule</th>
                    <th>Seats</th>
                    <th>Exam Time</th>
                </tr>
            </thead>
            <tbody id="courseTable"></tbody>
        </table>
    </div>

    <script>
        let activeButton = document.querySelector('.semester-button.active');
        const tableBody = document.getElementById('courseTable');
        const searchInput = document.getElementById('searchInput');

        let currentPage = 1;
        const itemsPerPage = 50;
        let currentData = [];
        let filteredData = [];

        const semesterData = {
            fall: null,
            summer: null,
            spring: null
        };

        async function loadSpringData() {
    try {
        const cdnResponse = await fetch('https://usis-cdn.eniamza.com/connect.json');
        const statusDiv = document.getElementById('data-status');

        if (!cdnResponse.ok) throw new Error('CDN fetch failed');
        const cdnData = await cdnResponse.json();

        // Update status for live data
        statusDiv.innerHTML = 'ðŸŸ¢ Live Data: Connected to CDN';
        statusDiv.style.backgroundColor = '#d4edda';
        statusDiv.style.color = '#155724';

        return normalizeCourseData(cdnData, 'spring25');
    } catch (cdnError) {
        console.warn('Using fallback spring data:', cdnError.message);
        const statusDiv = document.getElementById('data-status');

        const fileResponse = await fetch('spring-usisdump.json');
        if (!fileResponse.ok) throw new Error('Both CDN and file fetch failed');
        const fileData = await fileResponse.json();

        // Update status for offline data
        statusDiv.innerHTML = 'ðŸ”´ Offline Data: Loaded from Local File';
        statusDiv.style.backgroundColor = '#f8d7da';
        statusDiv.style.color = '#721c24';

        return normalizeCourseData(fileData, 'spring25');
    }
}

// Modify the loadCourseData function to handle status for other semesters
async function loadCourseData(semester, filename) {
    try {
        let data;
        const statusDiv = document.getElementById('data-status');

        if (semester === 'spring') {
            data = await loadSpringData();
        } else {
            const response = await fetch(filename);
            if (!response.ok) throw new Error(`Failed to load ${filename}`);
            const rawData = await response.json();
            data = normalizeCourseData(rawData.data || [], 'old');

            // Update status for semester-specific data
            statusDiv.innerHTML = `ðŸŸ  Local Data: ${semester.charAt(0).toUpperCase() + semester.slice(1)} 2024 Semester`;
            statusDiv.style.backgroundColor = '#fff3cd';
            statusDiv.style.color = '#856404';
        }

        semesterData[semester] = data;
        currentData = data;
        filteredData = [...data];
        currentPage = 1;
        updateDisplay();
    } catch (error) {
        handleError(error);
    }
}

        // Time conversion utilities
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [timePart, period] = timeStr.split(/(?=[AP]M)/i);
            const [hours, minutes] = timePart.split(':').map(Number);
            let total = hours * 60 + minutes;
            if (period?.toUpperCase() === 'PM' && hours < 12) total += 720;
            if (period?.toUpperCase() === 'AM' && hours === 12) total -= 720;
            return total;
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${mins.toString().padStart(2, '0')} ${period}`;
        }

        // Data normalization
        function normalizeCourseData(data, format) {
            return data.map(course => ({
                code: course.courseCode,
                section: format === 'spring25' ? course.sectionName : (course.courseDetails?.match(/\[(.*?)\]/) || [,''])[1],
                faculty: format === 'spring25' ? (course.faculties || 'TBA') : (course.empName || 'TBA'),
                schedule: getComparableSchedule(course, format),
                examDate: format === 'spring25'
                    ? (course.sectionSchedule?.finalExamDetail || course.examDate || 'TBA')
                    : (course.examDate || course.dayNo || 'TBA'),
                seats: format === 'spring25' ? {
                    available: course.availableSeats || 0,
                    capacity: course.seatCapacity || 0,
                    waitlist: course.waitlistSeats || 0
                } : null
            }));
        }

        function getComparableSchedule(course, format) {
            if (format === 'spring25') {
                return (course.sectionSchedule?.classSchedules || []).map(s => ({
                    day: s.day.substring(0, 3).toUpperCase(),
                    start: timeToMinutes(s.startTime),
                    end: timeToMinutes(s.endTime)
                }));
            }
            return (course.classSchedule?.split('\n') || []).map(entry => {
                const match = entry.match(/(\w+?)\((\d+:\d+ [AP]M)/i);
                return match ? {
                    day: match[1].substring(0, 3).toUpperCase(),
                    start: timeToMinutes(match[2]),
                    end: null
                } : null;
            }).filter(Boolean);
        }

        // Enhanced matching logic
        function findMatches(springCourse) {
    const matches = [];

    // Ensure we have data for previous semesters
    ['fall', 'summer'].forEach(semester => {
        if (!semesterData[semester]) return;

        // Find courses with same course code
        const sameCourseCodeGroup = semesterData[semester].filter(
            prevCourse => prevCourse.code === springCourse.code
        );

        sameCourseCodeGroup.forEach(prevCourse => {
            // Skip if it's the same section
            if (prevCourse.section === springCourse.section) return;

            // More flexible time matching
            const hasTimeOverlap = springCourse.schedule.some(springTime =>
                prevCourse.schedule.some(prevTime =>
                    // Check day match and time proximity
                    springTime.day === prevTime.day &&
                    Math.abs(springTime.start - prevTime.start) < 90 // Within 1.5 hours
                )
            );

            // Only add if time overlaps and faculty is not 'TBA'
            if (hasTimeOverlap && prevCourse.faculty !== 'TBA') {
                matches.push({
                    faculty: prevCourse.faculty,
                    section: prevCourse.section,
                    semester: semester,
                    schedule: prevCourse.schedule
                });
            }
        });
    });

    return matches;
}

        // Display functions
        function buildMatchInfo(matches) {
    if (!matches.length) {
        return `<div class="tba-info">TBA</div>`;
    }

    const uniqueFaculty = [];
    const seenFaculty = new Set();

    matches.forEach(match => {
        if (!seenFaculty.has(match.faculty)) {
            uniqueFaculty.push(match);
            seenFaculty.add(match.faculty);
        }
    });

    let html = `<div class="tba-info">TBA (Potential Faculty)</div>`;

    html += `
        <div class="semester-group">
            <div class="time-match">
                Potential Faculty:
                ${uniqueFaculty.map(match => `
                    <div>
                        <span class="section-match">${match.semester.toUpperCase()} 2024 Section</span>:
                        ${match.faculty}
                        (<span class="time-match">Section ${match.section},
                        ${match.schedule.map(s =>
                            `${s.day} ${formatTime(s.start)}`
                        ).join(', ')}</span>)
                    </div>
                `).join('')}
            </div>
        </div>`;

    return html;
}

        // Data loading with CDN fallback


        async function loadCourseData(semester, filename) {
            try {
                let data;
                if (semester === 'spring') {
                    data = await loadSpringData();
                } else {
                    const response = await fetch(filename);
                    if (!response.ok) throw new Error(`Failed to load ${filename}`);
                    const rawData = await response.json();
                    data = normalizeCourseData(rawData.data || [], 'old');
                }

                semesterData[semester] = data;
                currentData = data;
                filteredData = [...data];
                currentPage = 1;
                updateDisplay();
            } catch (error) {
                handleError(error);
            }
        }

        function updateDisplay() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);
            renderTable(pageData);
            updatePagination();
        }

        function renderTable(courses) {
    tableBody.innerHTML = '';

    courses.forEach(course => {
        const row = document.createElement('tr');
        let facultyInfo = course.faculty;
        let seatStatus = 'N/A';

        // Handle seat status
        if (course.seats) {
            seatStatus = course.seats.available > 0
                ? `<span class="seats-available">${course.seats.available}/${course.seats.capacity}</span>`
                : `<span class="seats-full">FULL (${course.seats.waitlist} waitlist)</span>`;
        }

        // Enhanced TBA faculty handling
        if (course.faculty === 'TBA') {
            const matches = findMatches(course);
            facultyInfo = buildMatchInfo(matches);
        }

        row.innerHTML = `
            <td>${course.code}</td>
            <td>${course.section}</td>
            <td>${course.faculty !== 'TBA' ? course.faculty.split(' ').pop() : 'TBA'}</td>
            <td>${facultyInfo}</td>
            <td>${course.schedule.map(s =>
                `${s.day} ${formatTime(s.start)}`).join('<br>')}
            </td>
            <td>${seatStatus}</td>
            <td>${course.examDate}</td>
        `;

        tableBody.appendChild(row);
    });
}

        // Pagination and utilities
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function handleError(error) {
            console.error('Error:', error);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7">
                        <div class="error-message">
                            ${error.message}
                        </div>
                    </td>
                </tr>
            `;
        }

        function filterTable() {
    const filter = searchInput.value.trim().toUpperCase();

    // More comprehensive search across multiple fields
    filteredData = currentData.filter(course => {
        // Check if any part of the search matches
        const matchCode = course.code.toUpperCase().includes(filter);
        const matchSection = course.section.toUpperCase().includes(filter);
        const matchFaculty = course.faculty.toUpperCase().includes(filter);
        const matchSchedule = course.schedule.some(schedule =>
            `${schedule.day} ${formatTime(schedule.start)}`.toUpperCase().includes(filter)
        );

        return matchCode || matchSection || matchFaculty || matchSchedule;
    });

    // Reset to first page after filtering
    currentPage = 1;
    updateDisplay();

    // Update pagination info
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
}
        // Initialization
        Promise.all([
            fetch('old-usisdump.json').then(r => r.json()).then(data => {
                semesterData.fall = normalizeCourseData(data.data || [], 'old');
            }),
            fetch('summer-usisdump.json').then(r => r.json()).then(data => {
                semesterData.summer = normalizeCourseData(data.data || [], 'old');
            }),
            loadSpringData().then(data => {
                semesterData.spring = data;
            })
        ]).then(() => {
            loadCourseData('fall', 'old-usisdump.json');
        }).catch(handleError);

        // Event listeners
        document.querySelectorAll('.semester-button').forEach(button => {
            button.addEventListener('click', function() {
                activeButton.classList.remove('active');
                this.classList.add('active');
                activeButton = this;
                searchInput.value = '';
                const semester = this.dataset.semester;
                if (semester === 'spring') {
                    loadCourseData(semester);
                } else {
                    loadCourseData(semester, this.dataset.file);
                }
            });
        });

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateDisplay();
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (currentPage * itemsPerPage < filteredData.length) {
                currentPage++;
                updateDisplay();
            }
        });

        searchInput.addEventListener('input', filterTable);
    </script>
</body>
</html>
